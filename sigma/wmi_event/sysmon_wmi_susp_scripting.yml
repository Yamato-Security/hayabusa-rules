
title: Suspicious Scripting in a WMI Consumer
author: Florian Roth, Jonhnathan Ribeiro
date: 2019/04/15
description: Detects suspicious scripting in WMI Event Consumers
detection:
  SELECTION_1:
    EventID: 19
  SELECTION_10:
    Destination: '*.downloadfile*'
  SELECTION_11:
    Destination:
    - '* iex(*'
    - '*WScript.shell*'
    - '* -nop *'
    - '* -noprofile *'
    - '* -decode *'
    - '* -enc *'
  SELECTION_12:
    Destination:
    - '*WScript.Shell*'
    - '*System.Security.Cryptography.FromBase64Transform*'
  SELECTION_2:
    EventID: 20
  SELECTION_3:
    EventID: 21
  SELECTION_4:
    Channel: Microsoft-Windows-Sysmon/Operational
  SELECTION_5:
    Destination: '*new-object*'
  SELECTION_6:
    Destination: '*net.webclient*'
  SELECTION_7:
    Destination: '*.downloadstring*'
  SELECTION_8:
    Destination: '*new-object*'
  SELECTION_9:
    Destination: '*net.webclient*'
  condition: (((SELECTION_1 or SELECTION_2 or SELECTION_3) and SELECTION_4) and ((SELECTION_5
    and SELECTION_6 and SELECTION_7) or (SELECTION_8 and SELECTION_9 and SELECTION_10)
    or SELECTION_11 or SELECTION_12))
falsepositives:
- Administrative scripts
fields:
- User
- Operation
id: fe21810c-2a8c-478f-8dd3-5a287fb2a0e0
level: high
logsource:
  category: wmi_event
  product: windows
modified: 2021/09/01
references:
- https://in.security/an-intro-into-abusing-and-identifying-wmi-event-subscriptions-for-persistence/
- https://github.com/Neo23x0/signature-base/blob/master/yara/gen_susp_lnk_files.yar#L19
- https://github.com/RiccardoAncarani/LiquidSnake
status: experimental
tags:
- attack.execution
- attack.t1059.005
