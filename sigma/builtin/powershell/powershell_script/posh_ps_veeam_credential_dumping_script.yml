title: Veeam Backup Servers Credential Dumping Script Execution
ruletype: Sigma
author: Nasreddine Bencherchali (Nextron Systems)
date: 2023/05/04
description: Detects execution of a PowerShell script that contains calls to the "Veeam.Backup"
    class, in order to dump stored credentials.
detection:
    SELECTION_1:
        EventID: 4104
    SELECTION_2:
        Channel:
        - Microsoft-Windows-PowerShell/Operational
        - PowerShellCore/Operational
    SELECTION_3:
        ScriptBlockText: '*[Credentials]*'
    SELECTION_4:
        ScriptBlockText: '*[Veeam.Backup.Common.ProtectedStorage]::GetLocalString*'
    SELECTION_5:
        ScriptBlockText: '*Invoke-Sqlcmd*'
    SELECTION_6:
        ScriptBlockText: '*Veeam Backup and Replication*'
    condition: (SELECTION_1 and SELECTION_2 and SELECTION_3 and SELECTION_4 and SELECTION_5
        and SELECTION_6)
falsepositives:
- Administrators backup scripts (must be investigated)
id: 976d6e6f-a04b-4900-9713-0134a353e38b
level: high
logsource:
    category: ps_script
    definition: bade5735-5ab0-4aa7-a642-a11be0e40872
    product: windows
references:
- https://www.pwndefend.com/2021/02/15/retrieving-passwords-from-veeam-backup-servers/
- https://labs.withsecure.com/publications/fin7-target-veeam-servers
status: experimental
tags:
- attack.credential_access

